{% extends 'layout/menu.html' %}

{% block content %}
<h2>Dashboard de Movimientos</h2>

<!-- Formulario para seleccionar el tipo de movimiento -->
<form method="get" action="{% url 'dashboard' %}">
    <label for="tipo_movimiento">Filtrar por Tipo de Movimiento:</label>
    <select name="tipo_movimiento" id="tipo_movimiento">
        <option value="">Todos</option>
        {% for tipo in tipos_movimiento %}
        <option value="{{ tipo.id }}" {% if request.GET.tipo_movimiento == tipo.id|stringformat:"s" %}selected{% endif %}>
            {{ tipo.nombre }}
        </option>
        {% endfor %}
    </select>
    <button type="submit">Filtrar</button>
</form> 

<!-- Tabla de movimientos -->
<table border="1">
    <thead>
        <tr>
            <th>ID del Alumno</th>
            <th>Nombre del Alumno</th>
            <th>Tipo de Movimiento</th>
            <th>ID del Curso</th>
            <th>Nombre del Curso</th>
            <th>ID del Proyecto</th>
            <th>Nombre del Proyecto</th>
            <th>Tareas Asignadas</th> <!-- Nueva columna para mostrar las tareas -->
            <th>Fecha</th>
            <th>ID Movimiento</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for movimiento in movimientos %}
        <tr>
            <td>{{ movimiento.alumno_id }}</td>
            <td>{{ movimiento.alumno_nombre }}</td>
            <td>{{ movimiento.tipo_movimiento }}</td>
            <td>{{ movimiento.curso_id }}</td>
            <td>{{ movimiento.curso_name }}</td>
            <td>{{ movimiento.proyecto_id }}</td>
            <td>{{ movimiento.proyecto_name }}</td>
            <td>
                <!-- Verificar si tiene tareas asignadas al proyecto -->
                {% if movimiento.proyecto_id %}
                    {% for tarea in movimiento.tareas %}
                    <ul>
                        <li>{{ tarea.title }} ({{ tarea.done|yesno:"Completada,No completada" }})</li>
                    </ul>
                    {% empty %}
                    <span>No tiene tareas asignadas.</span>
                    {% endfor %}
                {% else %}
                <span>No tiene proyecto asignado.</span>
                {% endif %}
            </td>
            <td>{{ movimiento.fecha }}</td>
            <td>
                <!-- Botón para agregar tarea si hay proyecto asociado -->
                {% if movimiento.proyecto_id %}
                <a href="{% url 'agregar_tarea' movimiento.alumno_id movimiento.curso_id movimiento.proyecto_id %}">Agregar Tarea</a>
                {% else %}
                <a href="{% url 'asignar_proyecto' movimiento.alumno_id %}">Asignar Proyecto</a>
                {% endif %}

                <!-- Acción para eliminar el movimiento -->
                <form action="{% url 'confirmar_eliminar_movimiento' movimiento.id %}" method="GET">
                    {% csrf_token %}
                    <button>Eliminar Mov</button>
                </form> 
            </td>
            <td>
                <a href="{% url 'ver_actividad' movimiento.alumno_id %}" class="btn btn-info">Ver Actividad</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}